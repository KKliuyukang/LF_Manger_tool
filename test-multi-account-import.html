<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šè´¦æˆ·å¯¼å…¥å’Œæ±‡æ€»åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
            line-height: 1.6;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            background: #fafbfc;
        }
        
        .test-section h3 {
            color: #3498db;
            margin-top: 0;
        }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .test-result {
            margin: 15px 0;
            padding: 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .test-data {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }
        
        .test-data h4 {
            margin: 0 0 10px 0;
            color: #3498db;
        }
        
        .test-data pre {
            background: white;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #e1e8ed;
        }
        
        .status-display {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e1e8ed;
            margin: 15px 0;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .status-label {
            font-weight: 500;
        }
        
        .status-value {
            color: #3498db;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¦ å¤šè´¦æˆ·å¯¼å…¥å’Œæ±‡æ€»åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>1. æ¨¡å—åŠ è½½æµ‹è¯•</h3>
            <div class="test-buttons">
                <button class="btn-primary" onclick="testModuleLoading()">æ£€æŸ¥æ¨¡å—åŠ è½½</button>
                <button class="btn-primary" onclick="testFinanceInit()">åˆå§‹åŒ–è´¢åŠ¡æ¨¡å—</button>
            </div>
            <div id="module-loading-result"></div>
        </div>
        
        <div class="test-section">
            <h3>2. è´¦æˆ·ç®¡ç†æµ‹è¯•</h3>
            <div class="test-buttons">
                <button class="btn-success" onclick="createTestAccounts()">åˆ›å»ºæµ‹è¯•è´¦æˆ·</button>
                <button class="btn-primary" onclick="listAllAccounts()">æŸ¥çœ‹è´¦æˆ·åˆ—è¡¨</button>
                <button class="btn-warning" onclick="toggleAccountStatus()">åˆ‡æ¢è´¦æˆ·çŠ¶æ€</button>
            </div>
            <div id="account-management-result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. æ•°æ®å¯¼å…¥æµ‹è¯•</h3>
            <div class="test-data">
                <h4>æµ‹è¯•æ•°æ® - å·¥å•†é“¶è¡Œè´¦æˆ·</h4>
                <pre id="icbc-test-data">{
  "2024-01": {
    "incomeDetails": [
      {"name": "åŸºæœ¬å·¥èµ„", "amount": 12000, "currency": "CNY", "category": "å·¥èµ„", "description": "æœˆåº¦åŸºæœ¬å·¥èµ„"},
      {"name": "å¥–é‡‘", "amount": 3000, "currency": "CNY", "category": "å·¥èµ„", "description": "æœˆåº¦å¥–é‡‘"}
    ],
    "expenses": [
      {"name": "æˆ¿ç§Ÿ", "amount": 3000, "currency": "CNY", "category": "ä½æˆ¿"},
      {"name": "ç”Ÿæ´»è´¹", "amount": 2000, "currency": "CNY", "category": "ç”Ÿæ´»"}
    ]
  },
  "2024-02": {
    "incomeDetails": [
      {"name": "åŸºæœ¬å·¥èµ„", "amount": 12000, "currency": "CNY", "category": "å·¥èµ„", "description": "æœˆåº¦åŸºæœ¬å·¥èµ„"},
      {"name": "é¡¹ç›®å¥–é‡‘", "amount": 3000, "currency": "CNY", "category": "å·¥èµ„", "description": "é¡¹ç›®å®Œæˆå¥–é‡‘"}
    ],
    "expenses": [
      {"name": "æˆ¿ç§Ÿ", "amount": 3000, "currency": "CNY", "category": "ä½æˆ¿"},
      {"name": "ç”Ÿæ´»è´¹", "amount": 1800, "currency": "CNY", "category": "ç”Ÿæ´»"}
    ]
  }
}</pre>
            </div>
            
            <div class="test-data">
                <h4>æµ‹è¯•æ•°æ® - æ¾³æ´²è”é‚¦é“¶è¡Œè´¦æˆ·</h4>
                <pre id="anz-test-data">{
  "2024-01": {
    "incomeDetails": [
      {"name": "Salary", "amount": 2800, "currency": "AUD", "category": "å·¥èµ„", "description": "Monthly salary"},
      {"name": "Investment", "amount": 400, "currency": "AUD", "category": "æŠ•èµ„", "description": "Share dividends"}
    ],
    "expenses": [
      {"name": "Rent", "amount": 800, "currency": "AUD", "category": "ä½æˆ¿"},
      {"name": "Groceries", "amount": 300, "currency": "AUD", "category": "ç”Ÿæ´»"}
    ]
  },
  "2024-02": {
    "incomeDetails": [
      {"name": "Salary", "amount": 2800, "currency": "AUD", "category": "å·¥èµ„", "description": "Monthly salary"},
      {"name": "Bonus", "amount": 400, "currency": "AUD", "category": "å·¥èµ„", "description": "Performance bonus"}
    ],
    "expenses": [
      {"name": "Rent", "amount": 800, "currency": "AUD", "category": "ä½æˆ¿"},
      {"name": "Groceries", "amount": 350, "currency": "AUD", "category": "ç”Ÿæ´»"}
    ]
  }
}</pre>
            </div>
            
            <div class="test-buttons">
                <button class="btn-success" onclick="importTestData('icbc')">å¯¼å…¥å·¥è¡Œæ•°æ®</button>
                <button class="btn-success" onclick="importTestData('anz')">å¯¼å…¥æ¾³è¡Œæ•°æ®</button>
                <button class="btn-primary" onclick="testDataValidation()">æµ‹è¯•æ•°æ®éªŒè¯</button>
            </div>
            <div id="data-import-result"></div>
        </div>
        
        <div class="test-section">
            <h3>4. æ•°æ®æ±‡æ€»æµ‹è¯•</h3>
            <div class="test-buttons">
                <button class="btn-primary" onclick="testAggregation()">æ‰§è¡Œæ•°æ®æ±‡æ€»</button>
                <button class="btn-warning" onclick="testCurrencyConversion()">æµ‹è¯•è´§å¸æ¢ç®—</button>
                <button class="btn-primary" onclick="testConflictDetection()">æ£€æµ‹æ•°æ®å†²çª</button>
                <button class="btn-danger" onclick="forceReaggregation()">å¼ºåˆ¶é‡æ–°æ±‡æ€»</button>
            </div>
            <div id="aggregation-result"></div>
        </div>
        
        <div class="test-section">
            <h3>5. æ±‡æ€»çŠ¶æ€ç›‘æ§</h3>
            <div class="test-buttons">
                <button class="btn-primary" onclick="showAggregationStatus()">æŸ¥çœ‹æ±‡æ€»çŠ¶æ€</button>
                <button class="btn-primary" onclick="exportAggregationReport()">å¯¼å‡ºæ±‡æ€»æŠ¥å‘Š</button>
            </div>
            <div id="status-result"></div>
        </div>
        
        <div class="test-section">
            <h3>6. é›†æˆæµ‹è¯•</h3>
            <div class="test-buttons">
                <button class="btn-success" onclick="runFullIntegrationTest()">è¿è¡Œå®Œæ•´é›†æˆæµ‹è¯•</button>
                <button class="btn-warning" onclick="resetAllData()">é‡ç½®æ‰€æœ‰æ•°æ®</button>
            </div>
            <div id="integration-result"></div>
        </div>
    </div>

    <!-- æ¨¡æ‹ŸåŸºç¡€ç¯å¢ƒ -->
    <script>
        // æ¨¡æ‹ŸgameData
        window.gameData = {
            billsData: {},
            displayCurrency: 'CNY'
        };
        
        // æ¨¡æ‹Ÿä¿å­˜å‡½æ•°
        window.saveToCloud = function() {
            console.log('æ¨¡æ‹Ÿä¿å­˜åˆ°äº‘ç«¯');
        };
        
        // æ¨¡æ‹Ÿå…³é—­æ¨¡æ€æ¡†å‡½æ•°
        window.closeModal = function(modalId) {
            console.log('æ¨¡æ‹Ÿå…³é—­æ¨¡æ€æ¡†:', modalId);
        };
        
        // å­˜å‚¨æµ‹è¯•è´¦æˆ·ID
        let testAccountIds = {
            icbc: null,
            anz: null
        };
    </script>
    
    <!-- åŠ è½½è´¢åŠ¡æ¨¡å— -->
    <script src="utils/finance-main.js"></script>
    <script src="utils/account-manager.js"></script>
    <script src="utils/bill-importer.js"></script>
    <script src="utils/data-aggregator.js"></script>
    
    <script>
        // æµ‹è¯•å‡½æ•°
        function testModuleLoading() {
            const resultDiv = document.getElementById('module-loading-result');
            let results = [];
            
            // æ£€æŸ¥å„æ¨¡å—æ˜¯å¦åŠ è½½
            const modules = [
                { name: 'FinanceModule', obj: window.FinanceModule },
                { name: 'AccountManager', obj: window.AccountManager },
                { name: 'BillImporter', obj: window.BillImporter },
                { name: 'DataAggregator', obj: window.DataAggregator }
            ];
            
            modules.forEach(module => {
                if (module.obj) {
                    results.push(`<div class="test-result success">âœ… ${module.name} æ¨¡å—åŠ è½½æˆåŠŸ</div>`);
                } else {
                    results.push(`<div class="test-result error">âŒ ${module.name} æ¨¡å—åŠ è½½å¤±è´¥</div>`);
                }
            });
            
            resultDiv.innerHTML = results.join('');
        }
        
        function testFinanceInit() {
            const resultDiv = document.getElementById('module-loading-result');
            
            try {
                if (window.FinanceModule) {
                    window.FinanceModule.init();
                    resultDiv.innerHTML += '<div class="test-result success">âœ… è´¢åŠ¡æ¨¡å—åˆå§‹åŒ–æˆåŠŸ</div>';
                    
                    // æ£€æŸ¥æ•°æ®ç»“æ„
                    if (gameData.financeData) {
                        resultDiv.innerHTML += '<div class="test-result info">â„¹ï¸ è´¢åŠ¡æ•°æ®ç»“æ„å·²åˆ›å»º</div>';
                        resultDiv.innerHTML += `<div class="test-result info">æ•°æ®ç»“æ„: <pre>${JSON.stringify(gameData.financeData, null, 2)}</pre></div>`;
                    }
                } else {
                    resultDiv.innerHTML += '<div class="test-result error">âŒ FinanceModule ä¸å­˜åœ¨</div>';
                }
            } catch (error) {
                resultDiv.innerHTML += `<div class="test-result error">âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function createTestAccounts() {
            const resultDiv = document.getElementById('account-management-result');
            let results = [];
            
            try {
                // åˆ›å»ºå·¥å•†é“¶è¡Œè´¦æˆ·
                const icbcId = window.AccountManager.createAccount({
                    name: 'å·¥å•†é“¶è¡Œå‚¨è“„å¡',
                    type: 'bank_debit',
                    currency: 'CNY'
                });
                testAccountIds.icbc = icbcId;
                results.push(`<div class="test-result success">âœ… å·¥å•†é“¶è¡Œè´¦æˆ·åˆ›å»ºæˆåŠŸï¼ŒID: ${icbcId}</div>`);
                
                // åˆ›å»ºæ¾³æ´²è”é‚¦é“¶è¡Œè´¦æˆ·
                const anzId = window.AccountManager.createAccount({
                    name: 'æ¾³æ´²è”é‚¦é“¶è¡Œ',
                    type: 'bank_debit', 
                    currency: 'AUD'
                });
                testAccountIds.anz = anzId;
                results.push(`<div class="test-result success">âœ… æ¾³æ´²è”é‚¦é“¶è¡Œè´¦æˆ·åˆ›å»ºæˆåŠŸï¼ŒID: ${anzId}</div>`);
                
                // åˆ›å»ºæ”¯ä»˜å®è´¦æˆ·
                const alipayId = window.AccountManager.createAccount({
                    name: 'æ”¯ä»˜å®ä¸»è´¦æˆ·',
                    type: 'alipay',
                    currency: 'CNY'
                });
                results.push(`<div class="test-result success">âœ… æ”¯ä»˜å®è´¦æˆ·åˆ›å»ºæˆåŠŸï¼ŒID: ${alipayId}</div>`);
                
            } catch (error) {
                results.push(`<div class="test-result error">âŒ è´¦æˆ·åˆ›å»ºå¤±è´¥: ${error.message}</div>`);
            }
            
            resultDiv.innerHTML = results.join('');
        }
        
        function listAllAccounts() {
            const resultDiv = document.getElementById('account-management-result');
            
            try {
                const accounts = window.AccountManager.getAccountList();
                let html = `<div class="test-result success">âœ… è·å–åˆ° ${accounts.length} ä¸ªè´¦æˆ·</div>`;
                
                if (accounts.length > 0) {
                    html += '<div class="status-display">';
                    accounts.forEach(account => {
                        const stats = window.AccountManager.getAccountStats(account.id);
                        html += `
                            <div class="status-item">
                                <span class="status-label">${account.icon} ${account.name}</span>
                                <span class="status-value">${account.currency} | ${account.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'} | ${stats.months}ä¸ªæœˆæ•°æ®</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ è·å–è´¦æˆ·åˆ—è¡¨å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function toggleAccountStatus() {
            const resultDiv = document.getElementById('account-management-result');
            
            try {
                if (testAccountIds.icbc) {
                    const newStatus = window.AccountManager.toggleAccountStatus(testAccountIds.icbc);
                    resultDiv.innerHTML = `<div class="test-result success">âœ… å·¥å•†é“¶è¡Œè´¦æˆ·çŠ¶æ€å·²åˆ‡æ¢ä¸º: ${newStatus ? 'å¯ç”¨' : 'ç¦ç”¨'}</div>`;
                } else {
                    resultDiv.innerHTML = '<div class="test-result error">âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•è´¦æˆ·</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ åˆ‡æ¢çŠ¶æ€å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function importTestData(accountType) {
            const resultDiv = document.getElementById('data-import-result');
            
            try {
                const accountId = testAccountIds[accountType];
                if (!accountId) {
                    resultDiv.innerHTML += '<div class="test-result error">âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•è´¦æˆ·</div>';
                    return;
                }
                
                const dataElement = document.getElementById(`${accountType}-test-data`);
                const testData = JSON.parse(dataElement.textContent);
                
                // ç¡®ä¿è´¢åŠ¡æ•°æ®ç»“æ„å­˜åœ¨
                if (!gameData.financeData) {
                    window.FinanceModule.initDataStructure();
                }
                
                // å¯¼å…¥æ•°æ®åˆ°æŒ‡å®šè´¦æˆ·
                if (!gameData.financeData.accountData[accountId]) {
                    gameData.financeData.accountData[accountId] = {};
                }
                
                Object.assign(gameData.financeData.accountData[accountId], testData);
                
                // æ›´æ–°è´¦æˆ·ä¿¡æ¯
                const account = gameData.financeData.accounts[accountId];
                if (account) {
                    account.lastUpdated = new Date().toISOString();
                }
                
                const monthsCount = Object.keys(testData).length;
                resultDiv.innerHTML += `<div class="test-result success">âœ… æˆåŠŸå¯¼å…¥ ${monthsCount} ä¸ªæœˆçš„æ•°æ®åˆ° ${accountType.toUpperCase()} è´¦æˆ·</div>`;
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="test-result error">âŒ å¯¼å…¥ ${accountType} æ•°æ®å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function testDataValidation() {
            const resultDiv = document.getElementById('data-import-result');
            
            try {
                const testData = JSON.parse(document.getElementById('icbc-test-data').textContent);
                const validation = window.BillImporter.validateImportData(testData);
                
                if (validation.valid) {
                    resultDiv.innerHTML += '<div class="test-result success">âœ… æ•°æ®éªŒè¯é€šè¿‡</div>';
                } else {
                    resultDiv.innerHTML += `<div class="test-result error">âŒ æ•°æ®éªŒè¯å¤±è´¥: ${validation.errors.join(', ')}</div>`;
                }
                
                // æµ‹è¯•æ— æ•ˆæ•°æ®
                const invalidData = { "invalid-month": "not an object" };
                const invalidValidation = window.BillImporter.validateImportData(invalidData);
                
                if (!invalidValidation.valid) {
                    resultDiv.innerHTML += '<div class="test-result success">âœ… æ— æ•ˆæ•°æ®æ­£ç¡®è¢«è¯†åˆ«</div>';
                } else {
                    resultDiv.innerHTML += '<div class="test-result error">âŒ æ— æ•ˆæ•°æ®éªŒè¯å¤±è´¥</div>';
                }
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="test-result error">âŒ æ•°æ®éªŒè¯æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function testAggregation() {
            const resultDiv = document.getElementById('aggregation-result');
            
            try {
                const result = window.DataAggregator.aggregateAllAccounts();
                const monthsCount = Object.keys(result).length;
                
                resultDiv.innerHTML = `<div class="test-result success">âœ… æ•°æ®æ±‡æ€»å®Œæˆï¼Œå¤„ç†äº† ${monthsCount} ä¸ªæœˆçš„æ•°æ®</div>`;
                
                // æ˜¾ç¤ºæ±‡æ€»ç»“æœ
                if (monthsCount > 0) {
                    let html = '<div class="status-display"><h4>æ±‡æ€»ç»“æœé¢„è§ˆ</h4>';
                    Object.entries(result).forEach(([month, data]) => {
                        const totalExpense = data.expenses.reduce((sum, exp) => sum + exp.amount, 0);
                        html += `
                            <div class="status-item">
                                <span class="status-label">${month}</span>
                                <span class="status-value">æ”¶å…¥: Â¥${data.income} | æ”¯å‡º: Â¥${totalExpense} | æ¥æº: ${data.sources.length}ä¸ªè´¦æˆ·</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                    resultDiv.innerHTML += html;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ æ•°æ®æ±‡æ€»å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function testCurrencyConversion() {
            const resultDiv = document.getElementById('aggregation-result');
            
            try {
                const converter = window.DataAggregator.convertToPrimaryCurrency;
                
                // æµ‹è¯•æ±‡ç‡æ¢ç®—
                const tests = [
                    { amount: 1000, from: 'CNY', to: 'CNY', expected: 1000 },
                    { amount: 1000, from: 'AUD', to: 'CNY', expected: 4800 },
                    { amount: 4800, from: 'CNY', to: 'AUD', expected: 1000 }
                ];
                
                let results = [];
                tests.forEach(test => {
                    const result = converter(test.amount, test.from, test.to);
                    const isCorrect = Math.abs(result - test.expected) < 1;
                    results.push(`
                        <div class="test-result ${isCorrect ? 'success' : 'error'}">
                            ${isCorrect ? 'âœ…' : 'âŒ'} ${test.amount} ${test.from} â†’ ${test.to}: ${result} (æœŸæœ›: ${test.expected})
                        </div>
                    `);
                });
                
                resultDiv.innerHTML += results.join('');
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="test-result error">âŒ è´§å¸æ¢ç®—æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function testConflictDetection() {
            const resultDiv = document.getElementById('aggregation-result');
            
            try {
                const conflicts = window.DataAggregator.detectDataConflicts();
                
                if (conflicts.length === 0) {
                    resultDiv.innerHTML += '<div class="test-result success">âœ… æœªå‘ç°æ•°æ®å†²çª</div>';
                } else {
                    resultDiv.innerHTML += `<div class="test-result error">âš ï¸ å‘ç° ${conflicts.length} ä¸ªæ½œåœ¨å†²çª</div>`;
                    
                    conflicts.forEach(conflict => {
                        resultDiv.innerHTML += `<div class="test-result info">å†²çªè¯¦æƒ…: ${conflict.month} - ${conflict.items.length} ä¸ªé‡å¤é¡¹</div>`;
                    });
                }
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="test-result error">âŒ å†²çªæ£€æµ‹å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function forceReaggregation() {
            const resultDiv = document.getElementById('aggregation-result');
            
            try {
                const result = window.DataAggregator.forceReaggregation();
                resultDiv.innerHTML += '<div class="test-result success">âœ… å¼ºåˆ¶é‡æ–°æ±‡æ€»å®Œæˆ</div>';
            } catch (error) {
                resultDiv.innerHTML += `<div class="test-result error">âŒ å¼ºåˆ¶é‡æ–°æ±‡æ€»å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function showAggregationStatus() {
            const resultDiv = document.getElementById('status-result');
            
            try {
                const stats = window.DataAggregator.getAggregationStats();
                
                let html = '<div class="status-display">';
                html += `<div class="status-item"><span class="status-label">è´¦æˆ·æ€»æ•°</span><span class="status-value">${stats.totalAccounts}</span></div>`;
                html += `<div class="status-item"><span class="status-label">å¯ç”¨è´¦æˆ·</span><span class="status-value">${stats.enabledAccounts}</span></div>`;
                html += `<div class="status-item"><span class="status-label">æ±‡æ€»æœˆä»½</span><span class="status-value">${stats.totalMonths}</span></div>`;
                html += `<div class="status-item"><span class="status-label">æœ€åæ±‡æ€»</span><span class="status-value">${stats.lastAggregation ? new Date(stats.lastAggregation).toLocaleString() : 'æœªæ±‡æ€»'}</span></div>`;
                html += '</div>';
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ è·å–æ±‡æ€»çŠ¶æ€å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function exportAggregationReport() {
            const resultDiv = document.getElementById('status-result');
            
            try {
                const report = window.DataAggregator.exportAggregationReport();
                
                resultDiv.innerHTML += '<div class="test-result success">âœ… æ±‡æ€»æŠ¥å‘Šå¯¼å‡ºæˆåŠŸ</div>';
                resultDiv.innerHTML += `<div class="test-result info">æŠ¥å‘Šå†…å®¹: <pre>${JSON.stringify(report, null, 2)}</pre></div>`;
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="test-result error">âŒ å¯¼å‡ºæ±‡æ€»æŠ¥å‘Šå¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function runFullIntegrationTest() {
            const resultDiv = document.getElementById('integration-result');
            resultDiv.innerHTML = '<div class="test-result info">ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´é›†æˆæµ‹è¯•...</div>';
            
            try {
                // 1. åˆå§‹åŒ–æ¨¡å—
                window.FinanceModule.init();
                resultDiv.innerHTML += '<div class="test-result success">âœ… æ­¥éª¤1: æ¨¡å—åˆå§‹åŒ–å®Œæˆ</div>';
                
                // 2. åˆ›å»ºæµ‹è¯•è´¦æˆ·
                createTestAccounts();
                resultDiv.innerHTML += '<div class="test-result success">âœ… æ­¥éª¤2: æµ‹è¯•è´¦æˆ·åˆ›å»ºå®Œæˆ</div>';
                
                // 3. å¯¼å…¥æµ‹è¯•æ•°æ®
                importTestData('icbc');
                importTestData('anz');
                resultDiv.innerHTML += '<div class="test-result success">âœ… æ­¥éª¤3: æµ‹è¯•æ•°æ®å¯¼å…¥å®Œæˆ</div>';
                
                // 4. æ‰§è¡Œæ•°æ®æ±‡æ€»
                const aggregationResult = window.DataAggregator.aggregateAllAccounts();
                resultDiv.innerHTML += '<div class="test-result success">âœ… æ­¥éª¤4: æ•°æ®æ±‡æ€»å®Œæˆ</div>';
                
                // 5. éªŒè¯ç»“æœ
                const stats = window.DataAggregator.getAggregationStats();
                if (stats.totalMonths > 0 && stats.enabledAccounts > 0) {
                    resultDiv.innerHTML += '<div class="test-result success">ğŸ‰ é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼</div>';
                } else {
                    resultDiv.innerHTML += '<div class="test-result error">âŒ é›†æˆæµ‹è¯•éªŒè¯å¤±è´¥</div>';
                }
                
                // æ˜¾ç¤ºæœ€ç»ˆç»Ÿè®¡
                resultDiv.innerHTML += `
                    <div class="status-display">
                        <h4>é›†æˆæµ‹è¯•ç»“æœ</h4>
                        <div class="status-item"><span class="status-label">æ€»è´¦æˆ·æ•°</span><span class="status-value">${stats.totalAccounts}</span></div>
                        <div class="status-item"><span class="status-label">å¯ç”¨è´¦æˆ·</span><span class="status-value">${stats.enabledAccounts}</span></div>
                        <div class="status-item"><span class="status-label">æ±‡æ€»æœˆä»½</span><span class="status-value">${stats.totalMonths}</span></div>
                        <div class="status-item"><span class="status-label">å…¼å®¹æ€§</span><span class="status-value">${gameData.billsData ? 'âœ… å‘åå…¼å®¹' : 'âŒ å…¼å®¹æ€§é—®é¢˜'}</span></div>
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML += `<div class="test-result error">âŒ é›†æˆæµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function resetAllData() {
            const resultDiv = document.getElementById('integration-result');
            
            try {
                // é‡ç½®gameData
                gameData.financeData = undefined;
                gameData.billsData = {};
                
                // é‡ç½®æµ‹è¯•è´¦æˆ·ID
                testAccountIds = { icbc: null, anz: null };
                
                // æ¸…ç©ºæ‰€æœ‰ç»“æœæ˜¾ç¤º
                document.getElementById('module-loading-result').innerHTML = '';
                document.getElementById('account-management-result').innerHTML = '';
                document.getElementById('data-import-result').innerHTML = '';
                document.getElementById('aggregation-result').innerHTML = '';
                document.getElementById('status-result').innerHTML = '';
                
                resultDiv.innerHTML = '<div class="test-result success">âœ… æ‰€æœ‰æ•°æ®å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°å¼€å§‹æµ‹è¯•</div>';
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ æ•°æ®é‡ç½®å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿›è¡Œæ¨¡å—æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            testModuleLoading();
        });
    </script>
</body>
</html> 