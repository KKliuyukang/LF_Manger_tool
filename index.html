<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Factorio - äººç”Ÿå·¥å‚</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <!-- Firebase compat CDNä¾èµ–ï¼Œå¿…é¡»åœ¨app.jsä¹‹å‰ -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <!-- é”™è¯¯å¤„ç†å’Œæ•°æ®éªŒè¯æ¨¡å— -->
    <script src="utils/error-handler.js"></script>
    <script src="utils/data-validator.js"></script>
    <!-- æ€§èƒ½ä¼˜åŒ–æ¨¡å— -->
    <script src="utils/performance-optimizer.js"></script>
    <!-- è“å›¾è‡ªåŠ¨åŒ–æ¨¡å— -->
    <script src="utils/blueprint-automation.js"></script>
    <!-- ä¸»åº”ç”¨è„šæœ¬ -->
    <script src="app.js"></script>
</head>
<body style="--font-family: 'Helvetica Neue', Arial, sans-serif;">
    <div class="container">
        <div class="header">
            <h1>âš™ï¸ Life Factorio</h1>
            <p>æ„å»ºä½ çš„äººç”Ÿè‡ªåŠ¨åŒ–å·¥å‚</p>
            <div id="sync-status" style="position:absolute;top:18px;right:32px;font-size:0.98em;color:#888;"></div>
        </div>

        <div class="main-grid">
            <!-- å·¦ä¾§ï¼šç”Ÿäº§çº¿ -->
            <div class="panel" style="grid-area: production;">
                <h2 class="panel-title"><span class="conveyor-belt">âš™ï¸</span><span>ç”Ÿäº§çº¿</span></h2>
                <div class="panel-actions">
                    <button class="btn btn-add" onclick="window.showProductionModal()">+ ç”Ÿäº§</button>
                    <button id="add-blueprint-btn" class="btn btn-secondary">+ è“å›¾</button>
                    <button class="btn btn-automation" onclick="window.showBlueprintAutomationModal()">ğŸ¤– è‡ªåŠ¨åŒ–</button>
                </div>
                <div id="productions-list"></div>
            </div>
            
            <!-- ä¸­é—´åˆ—ï¼šæ—¥å† + ç ”å‘ä¸­å¿ƒ -->
            <div class="middle-column">
                <!-- æ—¥å† -->
                <div id="week-calendar" class="panel">
                    <div class="panel-title">
                        <span>ğŸ—“ï¸ æœ¬å‘¨æ—¶é—´æŠ•å…¥</span>
                        <div class="calendar-nav">
                            <button id="prev-week-btn" class="nav-btn">â† ä¸Šä¸€å‘¨</button>
                            <button id="today-btn" class="nav-btn">è¿”å›ä»Šå¤©</button>
                            <button id="next-week-btn" class="nav-btn">ä¸‹ä¸€å‘¨ â†’</button>
                        </div>
                        <span id="week-range-label" class="week-range"></span>
                    </div>
                </div>
                <!-- ç ”å‘ä¸­å¿ƒ -->
                <div class="panel research-panel">
                    <h2 class="panel-title"><span class="factory-icon">ğŸ­</span><span>ç ”å‘ä¸­å¿ƒ</span></h2>
                    <button class="btn dev-library-btn" onclick="forceRenderDevLibrary();">ğŸ“š æ‰“å¼€ç ”å‘åº“</button>
                    <div id="active-developments"></div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šèµ„æº & æ”¯å‡º -->
            <div style="grid-area: status; display:flex; flex-direction:column; gap:20px;">
                <div id="resource-panel" class="panel">
                    <h2 class="panel-title"><span>ğŸ“Š</span><span>èµ„æºæ•°æ®ç»Ÿè®¡</span></h2>
                    <div id="resource-stats"></div>
                </div>
                <div id="expenses-panel" class="panel">
                    <h2 class="panel-title"><span>ğŸ’¸</span><span>æ”¯å‡ºç®¡ç†</span></h2>
                    <div id="expenses-list"></div>
                    <button class="btn btn-add" onclick="window.showExpenseModal()">+ æ·»åŠ æ”¯å‡º</button>
                </div>
            </div>
            
            <!-- åº•éƒ¨ï¼šé‡Œç¨‹ç¢‘ -->
            <div class="panel" style="grid-area: milestones;">
                <h2 class="panel-title"><span>ğŸ¯</span><span>é‡Œç¨‹ç¢‘</span></h2>
                <div class="experience-section" id="experiences-list"></div>
            </div>
        </div>
    </div>

    <!-- å³é”®èœå• -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" onclick="window.editContextItem()">ç¼–è¾‘</div>
        <div class="context-menu-item" onclick="window.removeContextItem()">åˆ é™¤</div>
        <div class="context-menu-item" onclick="window.recordTimeContextItem()">è®°å½•ç”¨æ—¶</div>
        <div class="context-menu-item" onclick="window.clearTimeContextItem()">æ¸…é™¤ç”¨æ—¶</div>
    </div>

    <!-- ç”Ÿäº§çº¿ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="production-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">ç¼–è¾‘ç”Ÿäº§çº¿</h3>
            <form id="production-form">
                <div class="form-group">
                    <label class="form-label">ç”Ÿäº§çº¿åç§°</label>
                    <input type="text" class="form-input" id="prod-name" required>
                </div>
                <!-- ç”Ÿæ´»ç±»å†å²æ ‡ç­¾ -->
                <div class="form-group" id="lifestyle-history-group" style="display:none;">
                    <label class="form-label">å†å²ç”Ÿæ´»é¡¹ç›® (ç‚¹å‡»å¿«é€Ÿé€‰æ‹©)</label>
                    <div id="lifestyle-history-tags" class="lifestyle-tag-container"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">ç±»å‹</label>
                    <select class="form-select" id="prod-type">
                        <option value="production">äº§çº¿ï¼ˆéœ€è¦æŠ•å…¥æ—¶é—´æ¢æ”¶å…¥ï¼Œå¦‚å…¨èŒå·¥ä½œã€å‰¯ä¸šç­‰ï¼‰</option>
                        <option value="investment">èµ„äº§ï¼ˆå¦‚è‚¡ç¥¨ã€å€ºåˆ¸ã€æˆ¿åœ°äº§ç­‰ï¼Œç»Ÿè®¡æ”¯å‡ºå’Œè¢«åŠ¨æ”¶å…¥ï¼‰</option>
                        <option value="automation">è‡ªåŠ¨åŒ–ï¼ˆé•¿æœŸåŸ¹å…»çš„ä¹ æƒ¯æˆ–è¡Œä¸ºï¼Œä¸»è¦ç”¨äºæ‰“å¡è®°å½•ï¼‰</option>
                        <option value="lifestyle">æ—¥å¸¸ï¼ˆæ—¥å¸¸è¡Œä¸ºè®°å½•ï¼Œå¦‚å¨±ä¹ã€ç¤¾äº¤ã€å­¦ä¹ ç­‰ï¼‰</option>
                    </select>
                </div>

                <div class="form-group" id="income-type-group">
                    <label class="form-label">
                        <input type="checkbox" class="form-checkbox" id="has-active-income">
                        æœ‰ä¸»åŠ¨æ”¶å…¥
                    </label>
                    <div class="form-row" id="active-income-row" style="display: none; margin-top: 10px;">
                        <input type="number" class="form-input" id="active-amount" placeholder="é‡‘é¢">
                        <select class="form-select" id="active-currency">
                            <option value="CNY">äººæ°‘å¸ Â¥</option>
                            <option value="AUD">æ¾³å…ƒ A$</option>
                            <option value="USD">ç¾å…ƒ $</option>
                            <option value="EUR">æ¬§å…ƒ â‚¬</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" class="form-checkbox" id="has-passive-income">
                        æœ‰è¢«åŠ¨æ”¶å…¥
                    </label>
                    <div class="form-row" id="passive-income-row" style="display: none; margin-top: 10px;">
                        <input type="number" class="form-input" id="passive-amount" placeholder="é‡‘é¢">
                        <select class="form-select" id="passive-currency">
                            <option value="CNY">äººæ°‘å¸ Â¥</option>
                            <option value="AUD">æ¾³å…ƒ A$</option>
                            <option value="USD">ç¾å…ƒ $</option>
                            <option value="EUR">æ¬§å…ƒ â‚¬</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="expense-group" style="display: none;">
                    <label class="form-label">æ”¯å‡ºé‡‘é¢</label>
                    <div class="form-row">
                        <input type="number" class="form-input" id="prod-expense-amount" placeholder="é‡‘é¢">
                        <select class="form-select" id="prod-expense-currency">
                            <option value="CNY">äººæ°‘å¸ Â¥</option>
                            <option value="AUD">æ¾³å…ƒ A$</option>
                            <option value="USD">ç¾å…ƒ $</option>
                            <option value="EUR">æ¬§å…ƒ â‚¬</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="linked-dev-group">
                    <label class="form-label">å…³è”ç ”å‘é¡¹ç›®ï¼ˆå¯é€‰ï¼‰</label>
                    <select class="form-select" id="linked-dev">
                        <option value="">æ— </option>
                    </select>
                </div>
                <!-- æŠ•èµ„ç±»ä¸“å±å­—æ®µ -->
                <div id="investment-fields" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">æŠ•å…¥é‡‘é¢</label>
                        <div class="form-row">
                            <input type="number" class="form-input" id="invest-amount" placeholder="æŠ•å…¥é‡‘é¢">
                            <select class="form-select" id="invest-currency">
                                <option value="CNY">äººæ°‘å¸ Â¥</option>
                                <option value="AUD">æ¾³å…ƒ A$</option>
                                <option value="USD">ç¾å…ƒ $</option>
                                <option value="EUR">æ¬§å…ƒ â‚¬</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æŠ•å…¥æ—¶é—´</label>
                        <input type="date" class="form-input" id="invest-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å½“å‰ä»·å€¼</label>
                        <div class="form-row">
                            <input type="number" class="form-input" id="invest-current" placeholder="å½“å‰ä»·å€¼">
                            <select class="form-select" id="invest-current-currency">
                                <option value="CNY">äººæ°‘å¸ Â¥</option>
                                <option value="AUD">æ¾³å…ƒ A$</option>
                                <option value="USD">ç¾å…ƒ $</option>
                                <option value="EUR">æ¬§å…ƒ â‚¬</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="window.closeModal('production-modal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç ”å‘åº“æ¨¡æ€æ¡† -->
    <div id="dev-library-modal" class="modal">
        <div class="modal-content">
            <div class="dev-library-grid" id="dev-library-list"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('dev-library-modal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ç ”ç©¶è¯¦æƒ…å¼¹çª— -->
    <div id="research-detail-modal" class="modal">
        <div class="modal-content" style="max-width: 500px; width: 90%; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <div class="modal-header">
                <h3 id="research-title" class="modal-title"></h3>
                <button class="modal-close" onclick="window.closeModal('research-detail-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="research-description" class="modal-description"></p>
                <div id="research-requirements" class="modal-requirements"></div>
            </div>
            <div class="modal-footer">
                <div class="create-production-checkbox">
                    <input type="checkbox" id="create-production-checkbox">
                    <label for="create-production-checkbox">åˆ›å»ºå¯¹åº”çš„ç”Ÿäº§çº¿</label>
                </div>
                <div class="modal-buttons">
                    <button id="start-research-button" class="btn btn-primary">å¼€å§‹ç ”ç©¶</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* ç ”å‘åº“å¼¹çª—æ ·å¼ */
        #dev-library-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #dev-library-modal .modal-content {
            background-color: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* ç ”ç©¶è¯¦æƒ…å¼¹çª—æ ·å¼ */
        #research-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
        }

        #research-detail-modal .modal-content {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #research-detail-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #34495e;
        }

        #research-detail-modal .modal-title {
            font-size: 1.5em;
            color: #3498db;
            margin: 0;
        }

        #research-detail-modal .modal-close {
            background: none;
            border: none;
            color: #95a5a6;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
        }

        #research-detail-modal .modal-close:hover {
            color: #e74c3c;
        }

        #research-detail-modal .modal-body {
            margin-bottom: 20px;
        }

        #research-detail-modal .modal-description {
            margin-bottom: 15px;
            line-height: 1.5;
        }

        #research-detail-modal .modal-requirements {
            margin-bottom: 15px;
        }

        #research-detail-modal .requirement {
            display: inline-block;
            padding: 5px 10px;
            margin: 0 5px 5px 0;
            background-color: #34495e;
            border-radius: 4px;
            font-size: 0.9em;
        }

        #research-detail-modal .requirement.completed {
            background-color: #27ae60;
        }

        #research-detail-modal .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #34495e;
        }

        #research-detail-modal .create-production-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #95a5a6;
            font-size: 0.9em;
        }

        #research-detail-modal .create-production-checkbox input {
            margin: 0;
            width: 16px;
            height: 16px;
        }

        #research-detail-modal .create-production-checkbox label {
            cursor: pointer;
        }
    </style>

    <!-- æ“ä½œæŒ‰é’® (å·²ç§»é™¤ï¼ŒåŠŸèƒ½é›†æˆåˆ°æ•°æ®ç®¡ç†ä¸­) -->

    <!-- è®°å½•ç”¨æ—¶å¼¹çª— -->
    <dialog id="record-time-dialog" style="border:none;border-radius:12px;box-shadow:0 4px 24px #0002;padding:0;max-width:340px;width:96vw;">
      <form method="dialog" id="record-time-form" style="padding:24px 20px 16px 20px;">
        <h3 style="margin-bottom:16px;font-size:1.15em;">è®°å½•ç”¨æ—¶</h3>
        <div class="form-group">
          <label class="form-label">æ—¥æœŸ</label>
          <input type="date" class="form-input" id="rt-date">
                            </div>
        <div class="form-group">
          <label class="form-label">èµ·å§‹æ—¶é—´</label>
          <input type="time" class="form-input" id="rt-start">
                        </div>
        <div class="form-group">
          <label class="form-label">ç»“æŸæ—¶é—´</label>
          <input type="time" class="form-input" id="rt-end">
                            </div>
        <div style="margin:12px 0 16px 0;">
          <div style="font-size:0.95em;color:#888;margin-bottom:8px;text-align:center;">å¿«é€Ÿæ—¶é•¿è®¾ç½®</div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:8px;">
            <button type="button" class="time-btn time-btn-forward" onclick="window.timeButtonClick(this, 'forward', 15)" title="ç‚¹å‡»å åŠ ï¼šå¼€å§‹æ—¶é—´å‘å‰æ¨15åˆ†é’Ÿ">âª 15åˆ†</button>
            <button type="button" class="time-btn time-btn-forward" onclick="window.timeButtonClick(this, 'forward', 30)" title="ç‚¹å‡»å åŠ ï¼šå¼€å§‹æ—¶é—´å‘å‰æ¨30åˆ†é’Ÿ">âª 30åˆ†</button>
            <button type="button" class="time-btn time-btn-forward" onclick="window.timeButtonClick(this, 'forward', 60)" title="ç‚¹å‡»å åŠ ï¼šå¼€å§‹æ—¶é—´å‘å‰æ¨1å°æ—¶">âª 1æ—¶</button>
            <button type="button" class="time-btn time-btn-forward" onclick="window.timeButtonClick(this, 'forward', 120)" title="ç‚¹å‡»å åŠ ï¼šå¼€å§‹æ—¶é—´å‘å‰æ¨2å°æ—¶">âª 2æ—¶</button>
          </div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
            <button type="button" class="time-btn time-btn-backward" onclick="window.timeButtonClick(this, 'backward', 15)" title="ç‚¹å‡»å åŠ ï¼šç»“æŸæ—¶é—´å‘åæ¨15åˆ†é’Ÿ">15åˆ† â©</button>
            <button type="button" class="time-btn time-btn-backward" onclick="window.timeButtonClick(this, 'backward', 30)" title="ç‚¹å‡»å åŠ ï¼šç»“æŸæ—¶é—´å‘åæ¨30åˆ†é’Ÿ">30åˆ† â©</button>
            <button type="button" class="time-btn time-btn-backward" onclick="window.timeButtonClick(this, 'backward', 60)" title="ç‚¹å‡»å åŠ ï¼šç»“æŸæ—¶é—´å‘åæ¨1å°æ—¶">1æ—¶ â©</button>
            <button type="button" class="time-btn time-btn-backward" onclick="window.timeButtonClick(this, 'backward', 120)" title="ç‚¹å‡»å åŠ ï¼šç»“æŸæ—¶é—´å‘åæ¨2å°æ—¶">2æ—¶ â©</button>
          </div>
                    </div>
        <div class="modal-buttons">
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
          <button type="button" class="btn btn-secondary" onclick="window.closeRecordTimeDialog()">å–æ¶ˆ</button>
                                    </div>
      </form>
    </dialog>

    <!-- è‡ªå®šä¹‰æ¨¡æ€æ¡†ï¼ˆå¼¹çª—ï¼‰æŒ‚è½½ç‚¹ -->
    <div id="custom-modal" class="modal" style="display:none;"></div>

    <!-- æ”¯å‡ºç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="expense-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">ç¼–è¾‘æ”¯å‡º</h3>
            <form id="expense-form">
                <div class="form-group">
                    <label class="form-label">æ”¯å‡ºåç§°</label>
                    <input type="text" class="form-input" id="expense-name" required>
                                    </div>
                <div class="form-group">
                    <label class="form-label">é‡‘é¢</label>
                    <input type="text" class="form-input" id="expense-amount" required autocomplete="off" inputmode="decimal">
                                    </div>
                <div class="form-group">
                    <label class="form-label">å¸ç§</label>
                    <select class="form-select" id="expense-currency">
                        <option value="CNY">äººæ°‘å¸ Â¥</option>
                        <option value="AUD">æ¾³å…ƒ A$</option>
                        <option value="USD">ç¾å…ƒ $</option>
                        <option value="EUR">æ¬§å…ƒ â‚¬</option>
                    </select>
                                </div>
                <div class="form-group">
                    <label class="form-label">æ”¯å‡ºæ—¶é—´</label>
                    <input type="date" class="form-input" id="expense-date" required>
                                    </div>
                <div class="form-group">
                    <label class="form-label">ç±»å‹</label>
                    <select class="form-select" id="expense-type">
                        <option value="single">å•æ¬¡æ”¯å‡º</option>
                        <option value="recurring">å›ºå®šæ”¯å‡º</option>
                    </select>
                                    </div>
                <div class="form-group" id="expense-frequency-group" style="display:none;">
                    <label class="form-label">é¢‘ç‡</label>
                    <select class="form-select" id="expense-frequency">
                        <option value="monthly">æ¯æœˆ</option>
                        <option value="biweekly">æ¯2å‘¨</option>
                        <option value="yearly">æ¯å¹´</option>
                    </select>
                                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <input type="text" class="form-input" id="expense-remark">
                                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="window.closeModal('expense-modal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                            </div>
            </form>
                </div>
    </div>

    <!-- ç ”å‘åº“ç®¡ç†å¼¹çª— -->
    <div id="dev-library-manage-modal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h3 class="modal-title">ç ”å‘åº“ç®¡ç†</h3>
            <div style="margin-bottom:12px;">
                <button class="btn btn-primary" onclick="window.exportDevLibrary()">å¯¼å‡ºç ”å‘åº“</button>
                <button class="btn btn-secondary" onclick="window.showImportDevLibrary()">æ‰¹é‡å¯¼å…¥/ç²˜è´´</button>
                <button class="btn btn-add" onclick="window.showAddDevLibraryItem()">+ æ–°å¢ç ”å‘é¡¹ç›®</button>
                                </div>
            <div id="dev-library-manage-list"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('dev-library-manage-modal')">å…³é—­</button>
                            </div>
                                </div>
                            </div>
    <!-- ç ”å‘åº“æ‰¹é‡å¯¼å…¥å¼¹çª— -->
    <div id="dev-library-import-modal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h3 class="modal-title">æ‰¹é‡å¯¼å…¥/ç²˜è´´ç ”å‘åº“</h3>
            <div style="margin-bottom:10px;">è¯·ç²˜è´´JSONæ•°ç»„ï¼Œæ¯é¡¹éœ€åŒ…å«ï¼šicon, category, researchName, prodName, freq, cycle, target, action, science</div>
            <textarea id="dev-library-import-text" style="width:100%;height:120px;"></textarea>
            <div class="modal-buttons">
                <button type="button" class="btn btn-primary" onclick="window.importDevLibrary()">å¯¼å…¥</button>
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('dev-library-import-modal')">å–æ¶ˆ</button>
                        </div>
        </div>
    </div>

    <!-- ç ”å‘åº“ç®¡ç†æŒ‰é’® (å·²ç§»é™¤) -->

    <!-- é‡Œç¨‹ç¢‘ç®¡ç†å¼¹çª— -->
    <div id="milestone-manage-modal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h3 class="modal-title">é‡Œç¨‹ç¢‘ç®¡ç†</h3>
            <div style="margin-bottom:12px;">
                <button class="btn btn-primary" onclick="window.exportMilestones()">å¯¼å‡ºé‡Œç¨‹ç¢‘</button>
                <button class="btn btn-secondary" onclick="window.showImportMilestones()">æ‰¹é‡å¯¼å…¥/ç²˜è´´</button>
                <button class="btn btn-add" onclick="window.showAddMilestoneItem()">+ æ–°å¢é‡Œç¨‹ç¢‘</button>
                    </div>
            <div id="milestone-manage-list"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('milestone-manage-modal')">å…³é—­</button>
                </div>
        </div>
    </div>
    <!-- é‡Œç¨‹ç¢‘æ‰¹é‡å¯¼å…¥å¼¹çª— -->
    <div id="milestone-import-modal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h3 class="modal-title">æ‰¹é‡å¯¼å…¥/ç²˜è´´é‡Œç¨‹ç¢‘</h3>
            <div style="margin-bottom:10px;">è¯·ç²˜è´´JSONæ•°ç»„ï¼Œæ¯é¡¹éœ€åŒ…å«ï¼šname, desc, count, repeatable, difficulty</div>
            <textarea id="milestone-import-text" style="width:100%;height:120px;"></textarea>
            <div class="modal-buttons">
                <button type="button" class="btn btn-primary" onclick="window.importMilestones()">å¯¼å…¥</button>
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('milestone-import-modal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- æ•°æ®ç®¡ç†æŒ‰é’® -->
    <button class="btn btn-secondary" style="position:fixed;top:18px;left:32px;z-index:100;" onclick="window.showDataManagePanel()">ğŸ’¾ æ•°æ®ç®¡ç†</button>

    <!-- æ—¶é—´è®°å½•ç»Ÿè®¡é¢æ¿ -->
    <div id="time-records-modal" class="modal">
        <div class="modal-content" style="max-width:800px;max-height:80vh;overflow-y:auto;">
            <h3 class="modal-title">æ—¶é—´è®°å½•ç»Ÿè®¡</h3>
            
            <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
            <div style="margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;">
                <button class="btn btn-small" onclick="window.showTimeRecords('today')">ä»Šå¤©</button>
                <button class="btn btn-small" onclick="window.showTimeRecords('week')">æœ¬å‘¨</button>
                <button class="btn btn-small" onclick="window.showTimeRecords('lastWeek')">ä¸Šå‘¨</button>
                <button class="btn btn-small" onclick="window.showTimeRecords('month')">æœ¬æœˆ</button>
                <button class="btn btn-small" onclick="window.showTimeRecords('lastMonth')">ä¸Šæœˆ</button>
                <button class="btn btn-small" onclick="window.showTimeRecords('year')">ä»Šå¹´</button>
                <button class="btn btn-small" onclick="window.showTimeRecords('all')">å…¨éƒ¨</button>
            </div>
            
            <!-- ç»Ÿè®¡ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="time-records-content"></div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('time-records-modal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ•°æ®ç®¡ç†é¢æ¿ -->
    <div id="data-manage-modal" class="modal">
        <div class="modal-content" style="max-width:600px;max-height:80vh;overflow-y:auto;">
            <h3 class="modal-title">ğŸ’¾ æ•°æ®ç®¡ç†ä¸­å¿ƒ</h3>
            
            <!-- çŠ¶æ€ä¿¡æ¯ -->
            <div id="data-status-info" style="background:#f8f9fa;border-radius:8px;padding:15px;margin-bottom:20px;">
                <div style="font-weight:bold;margin-bottom:10px;">ğŸ“Š å½“å‰çŠ¶æ€</div>
                <div id="status-details"></div>
            </div>
            
            <!-- å®¶åº­ç ç®¡ç† -->
            <div style="background:#fff3cd;border-radius:8px;padding:15px;margin-bottom:20px;">
                <div style="font-weight:bold;margin-bottom:10px;">ğŸ  å®¶åº­ç ç®¡ç†</div>
                <div style="margin-bottom:10px;">
                    <span>å½“å‰å®¶åº­ç ï¼š</span>
                    <code id="current-family-code" style="background:#e9ecef;padding:4px 8px;border-radius:4px;"></code>
                    <button class="btn btn-small btn-secondary" onclick="window.copyFamilyCode()" style="margin-left:8px;">ğŸ“‹ å¤åˆ¶</button>
                </div>
                <div style="margin-bottom:10px;">
                    <input type="text" id="new-family-code" placeholder="è¾“å…¥æ–°çš„å®¶åº­ç " class="form-input" style="width:200px;display:inline-block;margin-right:8px;">
                    <button class="btn btn-small btn-primary" onclick="window.changeFamilyCode()">ğŸ”„ æ›´æ¢</button>
                </div>
                <div style="font-size:0.9em;color:#666;">
                    âš ï¸ æ›´æ¢å®¶åº­ç ä¼šåˆ‡æ¢åˆ°æ–°çš„äº‘ç«¯æ•°æ®ç©ºé—´
                </div>
            </div>
            
            <!-- æ‰‹åŠ¨å¤‡ä»½æ¢å¤ -->
            <div style="background:#d1ecf1;border-radius:8px;padding:15px;margin-bottom:20px;">
                <div style="font-weight:bold;margin-bottom:10px;">ğŸ“ æ‰‹åŠ¨å¤‡ä»½ä¸æ¢å¤</div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
                    <button class="btn btn-primary" onclick="window.createManualBackup()">ğŸ’¾ åˆ›å»ºå¤‡ä»½æ–‡ä»¶</button>
                    <button class="btn btn-secondary" onclick="window.loadFromFile()">ğŸ“‚ ä»æ–‡ä»¶æ¢å¤</button>
                    <button class="btn btn-secondary" onclick="window.saveToFile()">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
                    <button class="btn btn-secondary" onclick="window.saveToLocal()">ğŸ’¿ æœ¬åœ°ä¿å­˜</button>
                </div>
                <div style="font-size:0.9em;color:#666;">
                    æ‰‹åŠ¨å¤‡ä»½ä¼šä¸‹è½½åŒ…å«æ‰€æœ‰æ•°æ®çš„JSONæ–‡ä»¶
                </div>
            </div>
            
            <!-- è‡ªåŠ¨äº‘å¤‡ä»½ -->
            <div style="background:#d4edda;border-radius:8px;padding:15px;margin-bottom:20px;">
                <div style="font-weight:bold;margin-bottom:10px;">â˜ï¸ è‡ªåŠ¨äº‘å¤‡ä»½</div>
                <div style="margin-bottom:10px;">
                    <label style="display:flex;align-items:center;cursor:pointer;">
                        <input type="checkbox" id="auto-backup-enabled" onchange="window.toggleAutoBackup(this.checked)" style="margin-right:8px;">
                        <span>å¯ç”¨è‡ªåŠ¨äº‘å¤‡ä»½ï¼ˆæ¯10åˆ†é’Ÿï¼‰</span>
                    </label>
                </div>
                <div style="margin-bottom:10px;">
                    <span>ä¸Šæ¬¡å¤‡ä»½ï¼š</span>
                    <span id="last-backup-time">æœªå¤‡ä»½</span>
                    <button class="btn btn-small btn-secondary" onclick="window.createCloudBackup()" style="margin-left:8px;">ğŸ”„ ç«‹å³å¤‡ä»½</button>
                </div>
                <div style="margin-bottom:10px;">
                    <button class="btn btn-small btn-secondary" onclick="window.listCloudBackups()">ğŸ“‹ æŸ¥çœ‹å¤‡ä»½åˆ—è¡¨</button>
                    <button class="btn btn-small btn-secondary" onclick="window.showRestoreFromCloud()">â˜ï¸ ä»äº‘å¤‡ä»½æ¢å¤</button>
                </div>
                <div style="font-size:0.9em;color:#666;">
                    äº‘å¤‡ä»½ç‹¬ç«‹å­˜å‚¨ï¼Œä¸å½±å“æ­£å¸¸ä½¿ç”¨æ•°æ®
                </div>
            </div>
            
            <!-- æ•°æ®ç®¡ç†åŠŸèƒ½ -->
            <div style="background:#e3f2fd;border-radius:8px;padding:15px;margin-bottom:20px;">
                <div style="font-weight:bold;margin-bottom:10px;">ğŸ› ï¸ æ•°æ®ç®¡ç†åŠŸèƒ½</div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
                    <button class="btn btn-secondary" onclick="window.showDevLibraryManage()">ğŸ› ï¸ ç ”å‘åº“ç®¡ç†</button>
                    <button class="btn btn-secondary" onclick="window.showMilestoneManage()">ğŸ† é‡Œç¨‹ç¢‘ç®¡ç†</button>
                    <button class="btn btn-secondary" onclick="window.showTimeRecordsPanel()">ğŸ“Š æ—¶é—´ç»Ÿè®¡</button>
                </div>
                <div style="font-size:0.9em;color:#666;">
                    ç®¡ç†ç ”å‘é¡¹ç›®åº“ã€é‡Œç¨‹ç¢‘æ•°æ®å’Œæ—¶é—´è®°å½•ç»Ÿè®¡
                </div>
            </div>
            
            <!-- ç´§æ€¥æ¢å¤ -->
            <div style="background:#f8d7da;border-radius:8px;padding:15px;margin-bottom:20px;">
                <div style="font-weight:bold;margin-bottom:10px;">ğŸš¨ ç´§æ€¥æ•°æ®æ¢å¤</div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
                    <button class="btn btn-danger" onclick="window.emergencyDataRecovery()">ğŸ”„ å°è¯•è‡ªåŠ¨æ¢å¤</button>
                    <button class="btn btn-secondary" onclick="window.showDataDebugInfo()">ğŸ” è°ƒè¯•ä¿¡æ¯</button>
                </div>
                <div style="font-size:0.9em;color:#666;">
                    å½“æ•°æ®ä¸¢å¤±æ—¶ä½¿ç”¨ï¼Œä¼šå°è¯•ä»æœ¬åœ°å­˜å‚¨å’Œäº‘ç«¯æ¢å¤
                </div>
            </div>
            
            <div style="text-align:right;">
                <button onclick="window.closeModal('data-manage-modal')" class="btn btn-secondary">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- è‡ªåŠ¨åŒ–è“å›¾ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="blueprint-automation-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h3 class="modal-title">ğŸ¤– è“å›¾è‡ªåŠ¨åŒ–ç®¡ç†</h3>
            
            <!-- çŠ¶æ€æ€»è§ˆ -->
            <div class="automation-status" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-weight: bold;">è‡ªåŠ¨åŒ–çŠ¶æ€</span>
                    <div>
                        <label class="switch">
                            <input type="checkbox" id="automation-enabled" onchange="toggleAutomation()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div id="automation-summary" style="font-size: 0.9em; color: #666;"></div>
            </div>
            
            <!-- å¿«é€Ÿæ“ä½œ -->
            <div class="automation-actions" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="generateAutomationBlueprints()">ğŸ¯ ç«‹å³ç”Ÿæˆè“å›¾</button>
                <button class="btn btn-secondary" onclick="clearAutoBlueprints()">ğŸ§¹ æ¸…é™¤è‡ªåŠ¨è“å›¾</button>
                <button class="btn btn-secondary" onclick="fixAutomationProjects()">ğŸ”§ ä¿®å¤é¡¹ç›®</button>
                <button class="btn btn-secondary" onclick="showAutomationSettings()">âš™ï¸ è®¾ç½®</button>
            </div>
            
            <!-- è‡ªåŠ¨åŒ–é¡¹ç›®åˆ—è¡¨ -->
            <div class="automation-projects">
                <h4>è‡ªåŠ¨åŒ–é¡¹ç›®</h4>
                <div id="automation-projects-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            
            <!-- ç”Ÿæˆæ—¥å¿— -->
            <div class="automation-logs" style="margin-top: 20px;">
                <h4>ç”Ÿæˆè®°å½•</h4>
                <div id="automation-logs-list" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 8px;"></div>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="window.closeModal('blueprint-automation-modal')" class="btn btn-secondary">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- è‡ªåŠ¨åŒ–è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="automation-settings-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">âš™ï¸ è‡ªåŠ¨åŒ–è®¾ç½®</h3>
            
            <div class="form-group">
                <label class="form-label">ç”ŸæˆèŒƒå›´</label>
                <select class="form-select" id="automation-range">
                    <option value="3">æœªæ¥3å¤©</option>
                    <option value="7" selected>æœªæ¥7å¤©</option>
                    <option value="14">æœªæ¥14å¤©</option>
                    <option value="30">æœªæ¥30å¤©</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">æ¯æ—¥æœ€å¤§è“å›¾æ•°é‡</label>
                <input type="number" class="form-input" id="max-daily-blueprints" min="1" max="20" value="8">
            </div>
            
            <div class="form-group">
                <label class="form-label">å·¥ä½œæ—¥/å‘¨æœ«ä¸åŒè§„åˆ™</label>
                <label class="switch">
                    <input type="checkbox" id="workday-rules" checked>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="form-group">
                <label class="form-label">ä¿æŠ¤æ—¶æ®µè®¾ç½®</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>ç¡çœ å¼€å§‹æ—¶é—´</label>
                        <input type="time" class="form-input" id="sleep-start" value="22:00">
                    </div>
                    <div>
                        <label>ç¡çœ ç»“æŸæ—¶é—´</label>
                        <input type="time" class="form-input" id="sleep-end" value="07:00">
                    </div>
                    <div>
                        <label>åˆä¼‘å¼€å§‹æ—¶é—´</label>
                        <input type="time" class="form-input" id="lunch-start" value="12:00">
                    </div>
                    <div>
                        <label>åˆä¼‘ç»“æŸæ—¶é—´</label>
                        <input type="time" class="form-input" id="lunch-end" value="13:00">
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button onclick="resetAutomationSettings()" class="btn btn-secondary">é‡ç½®é»˜è®¤</button>
                <div>
                    <button onclick="saveAutomationSettings()" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
                    <button onclick="window.closeModal('automation-settings-modal')" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°çš„è“å›¾æ¨¡æ€æ¡† -->
    <div id="blueprint-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">åˆ›å»ºè“å›¾è®¡åˆ’</h3>
            <form id="blueprint-form">
                <div class="form-group">
                    <label class="form-label">è®¡åˆ’åç§°</label>
                    <input type="text" class="form-input" id="blueprint-name" required>
                    <!-- è“å›¾å†å²æ ‡ç­¾ -->
                    <div id="blueprint-history-tags" style="margin-top: 8px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">ç±»åˆ«</label>
                    <select class="form-select" id="blueprint-category">
                        <option value="infrastructure">ğŸ—ï¸ åŸºç¡€è®¾æ–½</option>
                        <option value="production">ğŸ­ ç”Ÿäº§</option>
                        <option value="lifestyle">ğŸ–ï¸ æ—¥å¸¸</option>
                        <option value="automation">ğŸ¤– è‡ªåŠ¨åŒ–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="blueprint-date" class="form-label">è®¡åˆ’æ—¥æœŸå’Œæ—¶é—´</label>
                    <div class="datetime-quick-actions">
                        <button type="button" class="btn-time-quick" onclick="setBlueprintTime('now')">ç°åœ¨</button>
                        <button type="button" class="btn-time-quick" onclick="setBlueprintTime('tomorrow-9')">æ˜å¤©9ç‚¹</button>
                        <button type="button" class="btn-time-quick" onclick="setBlueprintTime('next-week')">ä¸‹å‘¨ä¸€</button>
                    </div>
                    <input type="datetime-local" id="blueprint-date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="blueprint-duration" class="form-label">è®¡åˆ’æ—¶é•¿ (åˆ†é’Ÿ)</label>
                    <div class="duration-options">
                        <button type="button" class="btn-duration" onclick="setBlueprintDuration(5)">5m</button>
                        <button type="button" class="btn-duration" onclick="setBlueprintDuration(15)">15m</button>
                        <button type="button" class="btn-duration" onclick="setBlueprintDuration(30)">30m</button>
                    </div>
                    <input type="number" id="blueprint-duration" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ä¼˜å…ˆçº§</label>
                    <div class="priority-options">
                        <label class="priority-option">
                            <input type="radio" name="priority" value="low">
                            <span class="priority-label low">ä½</span>
                        </label>
                        <label class="priority-option">
                            <input type="radio" name="priority" value="medium" checked>
                            <span class="priority-label medium">ä¸­</span>
                        </label>
                        <label class="priority-option">
                            <input type="radio" name="priority" value="high">
                            <span class="priority-label high">é«˜</span>
                        </label>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="window.closeModal('blueprint-modal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜è®¡åˆ’</button>
                </div>
            </form>
        </div>
    </div>

    <script src="utils/tech-tree-renderer.js"></script>
    <script>
        // DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
        // å½“é¡µé¢å®Œå…¨åŠ è½½åï¼Œç«‹å³é¢„åŠ è½½ç§‘æŠ€æ ‘æ•°æ®
        window.addEventListener('load', () => {
            if (window.loadDevLibraryFromJSON) {
                window.loadDevLibraryFromJSON();
            }
        });
    </script>   
</body>
</html>