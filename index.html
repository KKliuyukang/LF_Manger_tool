<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Factorio - 人生工厂</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <!-- Firebase compat CDN依赖，必须在app.js之前 -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <!-- 错误处理和数据验证模块 -->
    <script src="utils/error-handler.js"></script>
    <script src="utils/data-validator.js"></script>
    <!-- 性能优化模块 -->
    <script src="utils/performance-optimizer.js"></script>
    <!-- 蓝图自动化模块 -->
    <script src="utils/blueprint-automation.js"></script>
    <!-- 财务模块 - 需要在主应用之前加载 -->
    <script src="utils/finance-main.js"></script>
    <script src="utils/bill-importer.js"></script>
    <script src="utils/data-aggregator.js"></script>
    <script src="utils/account-manager.js"></script>
    <!-- 科技树渲染模块 -->
    <script src="utils/tech-tree-renderer.js"></script>
    
    <!-- 项目适应性管理系统 -->
    <script src="utils/project-adaptability-manager.js"></script>
    <script src="utils/adaptation-strategies.js"></script>
    
    <!-- 艾森豪威尔矩阵模块 -->
    <link rel="stylesheet" href="components/eisenhower-matrix/eisenhower-modal.css">
    <script src="components/eisenhower-matrix/eisenhower-modal.js"></script>
    
    <!-- 主应用脚本 -->
    <script src="app.js"></script>
    <!-- 模块加载状态检查 -->
    <script>
        // 立即检查模块加载状态
        setTimeout(() => {
            console.log('🔍 页面加载完成后的模块状态检查:');
            console.log('- BillImporter存在:', !!window.BillImporter);
            console.log('- showMultiAccountImportModal方法:', typeof window.BillImporter?.showMultiAccountImportModal);
            console.log('- AccountManager存在:', !!window.AccountManager);
            console.log('- FinanceModule存在:', !!window.FinanceModule);
            console.log('- DataAggregator存在:', !!window.DataAggregator);
            
            if (window.BillImporter) {
                console.log('✅ BillImporter模块方法列表:', Object.keys(window.BillImporter));
            } else {
                console.error('❌ BillImporter模块未找到');
            }
        }, 500);
    </script>
</head>
<body style="--font-family: 'Helvetica Neue', Arial, sans-serif;">
    <div class="container">
        <div class="main-grid">
            <!-- 左侧：生产线 -->
            <div class="panel" style="grid-area: production;">
                <h2 class="panel-title"><span class="conveyor-belt">⚙️</span><span>生产线</span></h2>
                <div class="panel-actions">
                    <button class="btn btn-add" onclick="window.showProductionModal()">+ 生产</button>
                    <button id="add-blueprint-btn" class="btn btn-secondary">+ 蓝图</button>
                    <button class="btn btn-automation" onclick="window.showBlueprintAutomationModal()">🤖 自动化</button>
                </div>
                <div id="productions-list"></div>
            </div>
            
            <!-- 中间列：日历 + 研发中心 -->
            <div class="middle-column">
                <!-- 日历 -->
                <div id="week-calendar" class="panel">
                    <div class="panel-title">
                        <span>🗓️ 本周时间投入</span>
                        <div class="calendar-nav">
                            <button id="prev-week-btn" class="nav-btn">◀ 上一周</button>
                            <button id="today-btn" class="nav-btn"> 本周 </button>
                            <button id="next-week-btn" class="nav-btn">下一周 ▶</button>
                        </div>
                        <span id="week-range-label" class="week-range"></span>
                    </div>
                </div>
                <!-- 研发中心 -->
                <div class="panel research-panel">
                    <h2 class="panel-title"><span class="factory-icon">🏭</span><span>研发中心</span></h2>
                    <button class="btn dev-library-btn" onclick="forceRenderDevLibrary();">📚 打开研发库</button>
                    <div id="active-developments"></div>
                </div>
            </div>
            
            <!-- 右侧状态列：包含三个面板 -->
            <div class="status-column">
                <!-- 今日主动用时 + 同步状态 -->
                <div id="resource-panel" class="panel compact-panel">
                    <div class="panel-title">
                        <span>LIFE-FACTORY</span>
                        <div id="sync-status" style="font-size:0.6em;color:#888;"></div>
                    </div>
                    <div id="resource-stats"></div>
                </div>
                
                <!-- 资源管理面板 -->
                <div id="expenses-panel" class="panel">
                    <div class="panel-title-wrapper">
                        <div class="panel-title-content">
                            <span class="panel-icon">💰</span>
                            <span class="panel-text">资源管理</span>
                        </div>
                    </div>
                    
                    <!-- 第一级：核心功能面板 -->
                    <div class="finance-main-content">
                        <!-- 简化财务概览 -->
                        <div id="finance-compact-overview"></div>
                        
                        <!-- 财务概览卡片 -->
                        <div class="finance-overview-card panel-content-collapsed">
                            <h4>📊 财务概览</h4>
                            <div id="finance-overview-content"></div>
                        </div>
                        
                        <!-- 快速操作区 -->
                        <div class="finance-actions-card panel-content-collapsed">
                            <h4>🚀 快速操作</h4>
                            <div class="finance-actions-grid">
                                <button class="btn btn-primary btn-finance-action" onclick="window.showBillImportModal()">
                                    📥 导入账单
                                </button>
                                <button class="btn btn-secondary btn-finance-action" onclick="window.showMonthlyComparisonModal()">
                                    📊 月度对比
                                </button>
                                <button class="btn btn-secondary btn-finance-action" onclick="window.showAccountManagementModal()">
                                    ⚙️ 管理账户
                                </button>
                                <button class="btn btn-danger btn-finance-action" onclick="window.showDataCleanupModal()">
                                    🧹 数据清理
                                </button>
                            </div>
                            <div class="account-status-summary panel-content-collapsed" id="account-status-summary"></div>
                        </div>
                        
                        <!-- 智能洞察卡片 -->
                        <div class="finance-insights-card panel-content-collapsed">
                            <h4>💡 智能洞察</h4>
                            <div id="finance-insights-content" class="panel-content-collapsed"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 里程碑面板 -->
                <div id="milestones-panel" class="panel">
                    <h2 class="panel-title"><span>🎯</span><span>里程碑</span></h2>
                    <div class="experience-section" id="experiences-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 右键菜单 -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" onclick="window.editContextItem()">编辑</div>
        <div class="context-menu-item" onclick="window.removeContextItem()">删除</div>
        <div class="context-menu-item" onclick="window.recordTimeContextItem()">记录用时</div>
        <div class="context-menu-item" onclick="window.clearTimeContextItem()">清除用时</div>
    </div>

    <!-- 全局生产线详情Tooltip -->
    <div id="production-tooltip" class="production-tooltip"></div>

    <!-- 生产线编辑模态框 -->
    <div id="production-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">编辑生产线</h3>
            <form id="production-form">
                <div class="form-group">
                    <label class="form-label">生产线名称</label>
                    <input type="text" class="form-input" id="prod-name" required>
                </div>
                <!-- 生活类历史标签 -->
                <div class="form-group" id="lifestyle-history-group" style="display:none;">
                    <label class="form-label">历史生活项目 (点击快速选择)</label>
                    <div id="lifestyle-history-tags" class="lifestyle-tag-container"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">类型</label>
                    <select class="form-select" id="prod-type">
                        <option value="production">产线（需要投入时间换收入，如全职工作、副业等）</option>
                        <option value="investment">资产（如股票、债券、房地产等，统计支出和被动收入）</option>
                        <option value="automation">自动化（长期培养的习惯或行为，主要用于打卡记录）</option>
                        <option value="lifestyle">日常（日常行为记录，如娱乐、社交、学习等）</option>
                        <option value="infrastructure">基建（基础设施建设，如健康、学习环境等）</option>
                        <option value="maintenance">维护（系统维护、设备保养等）</option>
                        <option value="research">研发（技术研究、知识学习等）</option>
                    </select>
                </div>

                <div class="form-group" id="income-type-group">
                    <label class="form-label">
                        <input type="checkbox" class="form-checkbox" id="has-active-income">
                        有主动收入
                    </label>
                    <div class="form-row" id="active-income-row" style="display: none; margin-top: 10px;">
                        <input type="number" class="form-input" id="active-amount" placeholder="金额">
                        <select class="form-select" id="active-currency">
                            <option value="CNY">人民币 ¥</option>
                            <option value="AUD">澳元 A$</option>
                            <option value="USD">美元 $</option>
                            <option value="EUR">欧元 €</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" class="form-checkbox" id="has-passive-income">
                        有被动收入
                    </label>
                    <div class="form-row" id="passive-income-row" style="display: none; margin-top: 10px;">
                        <input type="number" class="form-input" id="passive-amount" placeholder="金额">
                        <select class="form-select" id="passive-currency">
                            <option value="CNY">人民币 ¥</option>
                            <option value="AUD">澳元 A$</option>
                            <option value="USD">美元 $</option>
                            <option value="EUR">欧元 €</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="expense-group" style="display: none;">
                    <label class="form-label">支出金额</label>
                    <div class="form-row">
                        <input type="number" class="form-input" id="prod-expense-amount" placeholder="金额">
                        <select class="form-select" id="prod-expense-currency">
                            <option value="CNY">人民币 ¥</option>
                            <option value="AUD">澳元 A$</option>
                            <option value="USD">美元 $</option>
                            <option value="EUR">欧元 €</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="linked-dev-group">
                    <label class="form-label">关联研发项目（可选）</label>
                    <select class="form-select" id="linked-dev">
                        <option value="">无</option>
                    </select>
                </div>
                <!-- 投资类专属字段 -->
                <div id="investment-fields" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">投入金额</label>
                        <div class="form-row">
                            <input type="number" class="form-input" id="invest-amount" placeholder="投入金额">
                            <select class="form-select" id="invest-currency">
                                <option value="CNY">人民币 ¥</option>
                                <option value="AUD">澳元 A$</option>
                                <option value="USD">美元 $</option>
                                <option value="EUR">欧元 €</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">投入时间</label>
                        <input type="date" class="form-input" id="invest-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">当前价值</label>
                        <div class="form-row">
                            <input type="number" class="form-input" id="invest-current" placeholder="当前价值">
                            <select class="form-select" id="invest-current-currency">
                                <option value="CNY">人民币 ¥</option>
                                <option value="AUD">澳元 A$</option>
                                <option value="USD">美元 $</option>
                                <option value="EUR">欧元 €</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="window.closeModal('production-modal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 研发库模态框 -->
    <div id="dev-library-modal" class="modal">
        <div class="modal-content">
            <div class="dev-library-grid" id="dev-library-list"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('dev-library-modal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 研究详情弹窗 -->
    <div id="research-detail-modal" class="modal modal-medium">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="research-title" class="modal-title"></h3>
                <button class="modal-close" onclick="window.closeModal('research-detail-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="research-description" class="modal-description"></p>
                <div id="research-requirements" class="modal-requirements"></div>
            </div>
            <div class="modal-footer">
                <div class="create-production-checkbox">
                    <input type="checkbox" id="create-production-checkbox">
                    <label for="create-production-checkbox">创建对应的生产线</label>
                </div>
                <div class="modal-buttons">
                    <button id="start-research-button" class="btn btn-primary">开始研究</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* 研发库弹窗样式 */
        #dev-library-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #dev-library-modal .modal-content {
            background-color: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }




    </style>

    <!-- 操作按钮 (已移除，功能集成到数据管理中) -->

    <!-- 记录用时弹窗 -->
    <dialog id="record-time-dialog" style="border:none;border-radius:12px;box-shadow:0 4px 24px #0002;padding:0;max-width:340px;width:96vw;">
      <form method="dialog" id="record-time-form" style="padding:24px 20px 16px 20px;">
        <h3 style="margin-bottom:16px;font-size:1.15em;">记录用时</h3>
        <div class="form-group">
          <label class="form-label">日期</label>
          <input type="date" class="form-input" id="rt-date">
                            </div>
        <div class="form-group">
          <label class="form-label">起始时间</label>
          <input type="time" class="form-input" id="rt-start">
                        </div>
        <div class="form-group">
          <label class="form-label">结束时间</label>
          <input type="time" class="form-input" id="rt-end">
                            </div>
        <div style="margin:12px 0 16px 0;">
          <div style="font-size:0.95em;color:#888;margin-bottom:8px;text-align:center;">快速时长设置</div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:8px;">
            <button type="button" class="time-btn time-btn-forward" onclick="window.timeButtonClick(this, 'forward', 15)" title="点击叠加：开始时间向前推15分钟">⏪ 15分</button>
            <button type="button" class="time-btn time-btn-forward" onclick="window.timeButtonClick(this, 'forward', 30)" title="点击叠加：开始时间向前推30分钟">⏪ 30分</button>
            <button type="button" class="time-btn time-btn-forward" onclick="window.timeButtonClick(this, 'forward', 60)" title="点击叠加：开始时间向前推1小时">⏪ 1时</button>
            <button type="button" class="time-btn time-btn-forward" onclick="window.timeButtonClick(this, 'forward', 120)" title="点击叠加：开始时间向前推2小时">⏪ 2时</button>
          </div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
            <button type="button" class="time-btn time-btn-backward" onclick="window.timeButtonClick(this, 'backward', 15)" title="点击叠加：结束时间向后推15分钟">15分 ⏩</button>
            <button type="button" class="time-btn time-btn-backward" onclick="window.timeButtonClick(this, 'backward', 30)" title="点击叠加：结束时间向后推30分钟">30分 ⏩</button>
            <button type="button" class="time-btn time-btn-backward" onclick="window.timeButtonClick(this, 'backward', 60)" title="点击叠加：结束时间向后推1小时">1时 ⏩</button>
            <button type="button" class="time-btn time-btn-backward" onclick="window.timeButtonClick(this, 'backward', 120)" title="点击叠加：结束时间向后推2小时">2时 ⏩</button>
          </div>
                    </div>
        <div class="modal-buttons">
          <button type="submit" class="btn btn-primary">保存</button>
          <button type="button" class="btn btn-secondary" onclick="window.closeRecordTimeDialog()">取消</button>
                                    </div>
      </form>
    </dialog>

    <!-- 自定义模态框（弹窗）挂载点 -->
    <div id="custom-modal" class="modal" style="display:none;"></div>

    <!-- 支出编辑模态框 -->
    <div id="expense-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">编辑支出</h3>
            <form id="expense-form">
                <div class="form-group">
                    <label class="form-label">支出名称</label>
                    <input type="text" class="form-input" id="expense-name" required>
                                    </div>
                <div class="form-group">
                    <label class="form-label">金额</label>
                    <input type="text" class="form-input" id="expense-amount" required autocomplete="off" inputmode="decimal">
                                    </div>
                <div class="form-group">
                    <label class="form-label">币种</label>
                    <select class="form-select" id="expense-currency">
                        <option value="CNY">人民币 ¥</option>
                        <option value="AUD">澳元 A$</option>
                        <option value="USD">美元 $</option>
                        <option value="EUR">欧元 €</option>
                    </select>
                                </div>
                <div class="form-group">
                    <label class="form-label">支出时间</label>
                    <input type="date" class="form-input" id="expense-date" required>
                                    </div>
                <div class="form-group">
                    <label class="form-label">类型</label>
                    <select class="form-select" id="expense-type">
                        <option value="single">单次支出</option>
                        <option value="recurring">固定支出</option>
                    </select>
                                    </div>
                <div class="form-group" id="expense-frequency-group" style="display:none;">
                    <label class="form-label">频率</label>
                    <select class="form-select" id="expense-frequency">
                        <option value="monthly">每月</option>
                        <option value="biweekly">每2周</option>
                        <option value="yearly">每年</option>
                    </select>
                                </div>
                <div class="form-group">
                    <label class="form-label">备注</label>
                    <input type="text" class="form-input" id="expense-remark">
                                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="window.closeModal('expense-modal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                            </div>
            </form>
                </div>
    </div>

    <!-- 研发库管理弹窗 -->
    <div id="dev-library-manage-modal" class="modal modal-medium">
        <div class="modal-content">
            <h3 class="modal-title">研发库管理</h3>
            <div style="margin-bottom:12px;">
                <button class="btn btn-primary" onclick="window.exportDevLibrary()">导出研发库</button>
                <button class="btn btn-secondary" onclick="window.showImportDevLibrary()">批量导入/粘贴</button>
                <button class="btn btn-add" onclick="window.showAddDevLibraryItem()">+ 新增研发项目</button>
                                </div>
            <div id="dev-library-manage-list"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('dev-library-manage-modal')">关闭</button>
                            </div>
                                </div>
                            </div>
    <!-- 研发库批量导入弹窗 -->
    <div id="dev-library-import-modal" class="modal modal-medium">
        <div class="modal-content">
            <h3 class="modal-title">批量导入/粘贴研发库</h3>
            <div style="margin-bottom:10px;">请粘贴JSON数组，每项需包含：icon, category, researchName, prodName, freq, cycle, target, action, science</div>
            <textarea id="dev-library-import-text" style="width:100%;height:120px;"></textarea>
            <div class="modal-buttons">
                <button type="button" class="btn btn-primary" onclick="window.importDevLibrary()">导入</button>
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('dev-library-import-modal')">取消</button>
                        </div>
        </div>
    </div>

    <!-- 研发库管理按钮 (已移除) -->

    <!-- 里程碑管理弹窗 -->
    <div id="milestone-manage-modal" class="modal modal-medium">
        <div class="modal-content">
            <h3 class="modal-title">里程碑管理</h3>
            <div style="margin-bottom:12px;">
                <button class="btn btn-primary" onclick="window.exportMilestones()">导出里程碑</button>
                <button class="btn btn-secondary" onclick="window.showImportMilestones()">批量导入/粘贴</button>
                <button class="btn btn-add" onclick="window.showAddMilestoneItem()">+ 新增里程碑</button>
                    </div>
            <div id="milestone-manage-list"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('milestone-manage-modal')">关闭</button>
                </div>
        </div>
    </div>
    <!-- 里程碑批量导入弹窗 -->
    <div id="milestone-import-modal" class="modal modal-medium">
        <div class="modal-content">
            <h3 class="modal-title">批量导入/粘贴里程碑</h3>
            <div style="margin-bottom:10px;">请粘贴JSON数组，每项需包含：name, desc, count, repeatable, difficulty</div>
            <textarea id="milestone-import-text" style="width:100%;height:120px;"></textarea>
            <div class="modal-buttons">
                <button type="button" class="btn btn-primary" onclick="window.importMilestones()">导入</button>
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('milestone-import-modal')">取消</button>
            </div>
        </div>
    </div>
    <!-- 数据管理按钮 -->
    <button class="btn btn-secondary" style="position:fixed;top:18px;left:32px;z-index:100;" onclick="window.showDataManagePanel()">💾 数据管理</button>

    <!-- 时间记录统计面板 -->
    <div id="time-records-modal" class="modal modal-large">
        <div class="modal-content">
            <h3 class="modal-title">时间记录统计</h3>
            
            <!-- 时间范围选择 -->
            <div style="margin-bottom:20px;display:flex;gap:10px;flex-wrap:wrap;">
                <button class="btn btn-small" onclick="window.showTimeRecords('today')">今天</button>
                <button class="btn btn-small" onclick="window.showTimeRecords('week')">本周</button>
                <button class="btn btn-small" onclick="window.showTimeRecords('lastWeek')">上周</button>
                <button class="btn btn-small" onclick="window.showTimeRecords('month')">本月</button>
                <button class="btn btn-small" onclick="window.showTimeRecords('lastMonth')">上月</button>
                <button class="btn btn-small" onclick="window.showTimeRecords('year')">今年</button>
                <button class="btn btn-small" onclick="window.showTimeRecords('all')">全部</button>
            </div>
            
            <!-- 统计结果显示区域 -->
            <div id="time-records-content"></div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('time-records-modal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 时间记录编辑模态框 -->
    <div id="time-edit-modal" class="modal modal-medium">
        <div class="modal-content">
            <h3 class="modal-title">修改时间记录</h3>
            
            <form id="time-edit-form">
                <div class="form-group">
                    <label class="form-label">项目名称</label>
                    <div id="time-edit-project-name" style="padding:8px 12px;background:#f8f9fa;border-radius:4px;font-weight:bold;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">日期</label>
                    <input type="date" id="time-edit-date" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">开始时间</label>
                    <input type="time" id="time-edit-start" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">结束时间</label>
                    <input type="time" id="time-edit-end" class="form-input" required>
                </div>
                
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">保存修改</button>
                    <button type="button" class="btn btn-secondary" onclick="window.closeModal('time-edit-modal')">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 云备份管理模态框 -->
    <div id="cloud-backup-modal" class="modal modal-large">
        <div class="modal-content">
            <h3 class="modal-title">☁️ 云备份管理</h3>
            
            <!-- 备份列表显示区域 -->
            <div id="cloud-backup-content"></div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('cloud-backup-modal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 通用详情显示模态框 -->
    <div id="details-modal" class="modal modal-large">
        <div class="modal-content">
            <h3 id="details-modal-title" class="modal-title">详情信息</h3>
            
            <!-- 详情内容显示区域 -->
            <div id="details-modal-content"></div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('details-modal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 信息展示模态框 -->
    <div id="info-modal" class="modal modal-medium">
        <div class="modal-content">
            <h3 id="info-modal-title" class="modal-title">信息</h3>
            
            <!-- 信息内容显示区域 -->
            <div id="info-modal-content"></div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('info-modal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 数据管理面板 -->
    <div id="data-manage-modal" class="modal modal-large">
        <div class="modal-content">
            <h3 class="modal-title">💾 数据管理中心</h3>
            
            <!-- 当前状态 -->
            <div class="data-section data-section-gray">
                <div class="data-section-title">📊 当前状态</div>
                <div id="status-details"></div>
            </div>
            
            <!-- 家庭码管理 -->
            <div class="data-section data-section-yellow">
                <div class="data-section-title">🏠 家庭码管理</div>
                <div style="margin-bottom: var(--spacing-sm);">
                    <span>当前家庭码：</span>
                    <code id="current-family-code" class="family-code"></code>
                    <button class="btn btn-small btn-secondary btn-margin-left" onclick="window.copyFamilyCode()">📋 复制</button>
                </div>
                <div style="margin-bottom: var(--spacing-sm);">
                    <input type="text" id="new-family-code" placeholder="输入新的家庭码" class="form-input family-input">
                    <button class="btn btn-small btn-primary" onclick="window.changeFamilyCode()">🔄 更换</button>
                </div>
                <div class="data-info-text">
                    ⚠️ 更换家庭码会切换到新的云端数据空间
                </div>
            </div>
            
            <!-- 手动备份恢复 -->
            <div class="data-section data-section-blue">
                <div class="data-section-title">📁 手动备份与恢复</div>
                <div class="data-flex-container">
                    <button class="btn btn-primary" onclick="window.createManualBackup()">💾 创建备份文件</button>
                    <button class="btn btn-secondary" onclick="window.loadFromFile()">📂 从文件恢复</button>
                    <button class="btn btn-secondary" onclick="window.saveToFile()">💾 导出数据</button>
                    <button class="btn btn-secondary" onclick="window.saveToLocal()">💿 本地保存</button>
                </div>
                <div class="data-info-text">
                    手动备份会下载包含所有数据的JSON文件
                </div>
            </div>
            
            <!-- 自动云备份 -->
            <div class="data-section data-section-green">
                <div class="data-section-title">☁️ 自动云备份</div>
                <div style="margin-bottom: var(--spacing-sm);">
                    <label style="display:flex;align-items:center;cursor:pointer;">
                        <input type="checkbox" id="auto-backup-enabled" onchange="window.toggleAutoBackup(this.checked)" class="form-checkbox">
                        <span>启用自动云备份（每10分钟）</span>
                    </label>
                </div>
                <div style="margin-bottom: var(--spacing-sm);">
                    <span>上次备份：</span>
                    <span id="last-backup-time">未备份</span>
                    <button class="btn btn-small btn-secondary btn-margin-left" onclick="window.createCloudBackup()">🔄 立即备份</button>
                </div>
                <div class="data-flex-container">
                    <button class="btn btn-small btn-secondary" onclick="window.listCloudBackups()">📋 查看备份列表</button>
                    <button class="btn btn-small btn-secondary" onclick="window.showRestoreFromCloud()">☁️ 从云备份恢复</button>
                </div>
                <div class="data-info-text">
                    云备份独立存储，不影响正常使用数据
                </div>
            </div>
            
            <!-- 数据管理功能 -->
            <div class="data-section data-section-light-blue">
                <div class="data-section-title">🛠️ 数据管理功能</div>
                <div class="data-flex-container">
                    <button class="btn btn-secondary" onclick="window.showDevLibraryManage()">🛠️ 研发库管理</button>
                    <button class="btn btn-secondary" onclick="window.showMilestoneManage()">🏆 里程碑管理</button>
                    <button class="btn btn-secondary" onclick="window.showTimeRecordsPanel()">📊 时间统计</button>
                </div>
                <div class="data-info-text">
                    管理研发项目库、里程碑数据和时间记录统计
                </div>
            </div>
            
            <div class="modal-buttons">
                <button onclick="window.closeModal('data-manage-modal')" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- 自动化蓝图管理模态框 -->
    <div id="blueprint-automation-modal" class="modal modal-large">
        <div class="modal-content">
            <h3 class="modal-title">🤖 蓝图自动化管理</h3>
            
            <!-- 状态总览 -->
            <div class="automation-status" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-weight: bold;">自动化状态</span>
                    <div>
                        <label class="switch">
                            <input type="checkbox" id="automation-enabled" onchange="toggleAutomation()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div id="automation-summary" style="font-size: 0.9em; color: #666;"></div>
            </div>
            
            <!-- 快速操作 -->
            <div class="automation-actions" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="generateAutomationBlueprints()">🎯 立即生成蓝图</button>
                <button class="btn btn-secondary" onclick="clearAutoBlueprints()">🧹 清除自动蓝图</button>
                <button class="btn btn-secondary" onclick="fixAutomationProjects()">🔧 修复项目</button>
                <button class="btn btn-secondary" onclick="showAutomationSettings()">⚙️ 设置</button>
            </div>
            
            <!-- 自动化项目列表 -->
            <div class="automation-projects">
                <h4>自动化项目</h4>
                <div id="automation-projects-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            
            <!-- 生成日志 -->
            <div class="automation-logs" style="margin-top: 20px;">
                <h4>生成记录</h4>
                <div id="automation-logs-list" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 8px;"></div>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="window.closeModal('blueprint-automation-modal')" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- 自动化设置模态框 -->
    <div id="automation-settings-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">⚙️ 自动化设置</h3>
            
            <div class="form-group">
                <label class="form-label">生成范围</label>
                <select class="form-select" id="automation-range">
                    <option value="3">未来3天</option>
                    <option value="7" selected>未来7天</option>
                    <option value="14">未来14天</option>
                    <option value="30">未来30天</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">每日最大蓝图数量</label>
                <input type="number" class="form-input" id="max-daily-blueprints" min="1" max="20" value="8">
            </div>
            
            <div class="form-group">
                <label class="form-label">工作日/周末不同规则</label>
                <label class="switch">
                    <input type="checkbox" id="workday-rules" checked>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="form-group">
                <label class="form-label">保护时段设置</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>睡眠开始时间</label>
                        <input type="time" class="form-input" id="sleep-start" value="22:00">
                    </div>
                    <div>
                        <label>睡眠结束时间</label>
                        <input type="time" class="form-input" id="sleep-end" value="07:00">
                    </div>
                    <div>
                        <label>午休开始时间</label>
                        <input type="time" class="form-input" id="lunch-start" value="12:00">
                    </div>
                    <div>
                        <label>午休结束时间</label>
                        <input type="time" class="form-input" id="lunch-end" value="13:00">
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button onclick="resetAutomationSettings()" class="btn btn-secondary">重置默认</button>
                <div>
                    <button onclick="saveAutomationSettings()" class="btn btn-primary">保存设置</button>
                    <button onclick="window.closeModal('automation-settings-modal')" class="btn btn-secondary">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新的蓝图模态框 -->
    <div id="blueprint-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">创建蓝图计划</h3>
            <form id="blueprint-form">
                <div class="form-group">
                    <label class="form-label">计划名称</label>
                    <input type="text" class="form-input" id="blueprint-name" required>
                    <!-- 蓝图历史标签 -->
                    <div id="blueprint-history-tags" style="margin-top: 8px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">类别</label>
                    <select class="form-select" id="blueprint-category">
                        <option value="infrastructure">🏗️ 基础设施</option>
                        <option value="production">🏭 生产</option>
                        <option value="lifestyle">🏖️ 日常</option>
                        <option value="automation">🤖 自动化</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="blueprint-date" class="form-label">计划日期和时间</label>
                    <div class="datetime-quick-actions">
                        <button type="button" class="btn-time-quick" onclick="setBlueprintTime('now')">现在</button>
                        <button type="button" class="btn-time-quick" onclick="setBlueprintTime('tomorrow-9')">明天9点</button>
                        <button type="button" class="btn-time-quick" onclick="setBlueprintTime('next-week')">下周一</button>
                    </div>
                    <input type="datetime-local" id="blueprint-date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="blueprint-duration" class="form-label">计划时长 (分钟)</label>
                    <div class="duration-options">
                        <button type="button" class="btn-duration" onclick="setBlueprintDuration(5)">5m</button>
                        <button type="button" class="btn-duration" onclick="setBlueprintDuration(15)">15m</button>
                        <button type="button" class="btn-duration" onclick="setBlueprintDuration(30)">30m</button>
                    </div>
                    <input type="number" id="blueprint-duration" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">优先级</label>
                    <div class="priority-options">
                        <label class="priority-option">
                            <input type="radio" name="priority" value="low">
                            <span class="priority-label low">低</span>
                        </label>
                        <label class="priority-option">
                            <input type="radio" name="priority" value="medium" checked>
                            <span class="priority-label medium">中</span>
                        </label>
                        <label class="priority-option">
                            <input type="radio" name="priority" value="high">
                            <span class="priority-label high">高</span>
                        </label>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="window.closeModal('blueprint-modal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存计划</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // DOM加载完成后执行
        // 当页面完全加载后，立即预加载科技树数据
        window.addEventListener('load', () => {
            if (window.loadDevLibraryFromJSON) {
                window.loadDevLibraryFromJSON();
            }
        });
    </script>   
    <!-- 资源数据导入模态框 -->
    <div id="resource-import-modal" class="modal modal-large">
        <div class="modal-content">
            <h3 class="modal-title">📥 批量导入历史数据</h3>
            <div class="import-instructions">
                <h4>💡 使用说明</h4>
                <ol>
                    <li>导出银行交易记录CSV文件（支持多货币账单）</li>
                    <li>使用AI整理成以下JSON格式（注意添加currency字段）：</li>
                </ol>
                <pre class="import-example">{
  "2024-06": {
    "total": 2646.18,
    "currency": "AUD",
    "categories": {
      "home": 1680,
      "transport": 477.54,
      "groceries": 238.72,
      "dining": 82.50,
      "entertainment": 66.34,
      "others": 101.08
    },
    "fixed_expenses": ["home"],
    "unusual_items": ["IKEA购物 A$450"]
  },
  "2024-07": {
    "total": 15800,
    "currency": "CNY",
    "categories": {
      "home": 8500,
      "transport": 2300,
      "groceries": 1800,
      "dining": 1200,
      "entertainment": 800,
      "others": 1200
    },
    "fixed_expenses": ["home"],
    "unusual_items": ["年度保险 ¥3200"]
  }
}</pre>
                <p><strong>建议：</strong>每两周更新一次数据，保持分析的准确性</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">粘贴AI处理后的JSON数据</label>
                <textarea id="import-data-text" class="form-textarea" rows="10" placeholder="在此粘贴JSON数据..."></textarea>
            </div>
            
            <div class="form-group">
                <button type="button" class="btn btn-secondary" onclick="window.processImportData()">🔍 预览数据</button>
            </div>
            
            <div id="import-preview" class="import-preview"></div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('resource-import-modal')">取消</button>
            </div>
        </div>
    </div>



    <!-- 账户创建模态框 -->
    <div id="account-create-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">添加新账户</h3>
            <form id="account-create-form">
                <div class="form-group">
                    <label class="form-label">账户名称</label>
                    <input type="text" class="form-input" id="account-create-name" required placeholder="例如：工商银行储蓄卡">
                </div>
                <div class="form-group">
                    <label class="form-label">账户类型</label>
                    <select class="form-select" id="account-create-type" required>
                        <!-- 选项将通过JavaScript动态填充 -->
                    </select>
                </div>
                <div class="form-note">
                    <span class="note-text">💡 账户支持多货币，货币类型由导入的账单数据确定</span>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="window.closeModal('account-create-modal')">取消</button>
                    <button type="submit" class="btn btn-primary">创建账户</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 账户编辑模态框 -->
    <div id="account-edit-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">编辑账户</h3>
            <form id="account-edit-form">
                <div class="form-group">
                    <label class="form-label">账户名称</label>
                    <input type="text" class="form-input" id="account-edit-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">账户类型</label>
                    <select class="form-select" id="account-edit-type" required>
                        <!-- 选项将通过JavaScript动态填充 -->
                    </select>
                </div>
                <div class="form-note">
                    <span class="note-text">💡 账户支持多货币，货币类型由导入的账单数据确定</span>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-danger" onclick="AccountManager.deleteAccountFromModal()">删除账户</button>
                    <button type="button" class="btn btn-secondary" onclick="window.closeModal('account-edit-modal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存修改</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 账单导入模态框 -->
    <div id="bills-import-modal" class="modal modal-large">
        <div class="modal-content">
            <h3 class="modal-title">账单数据导入</h3>
            <div class="modal-body">
                <div class="import-instructions">
                    <h4>📋 使用说明</h4>
                    <p>1. 从银行导出CSV账单数据</p>
                    <p>2. 使用AI整理成JSON格式（参考下方示例）</p>
                    <p>3. <strong>重要：</strong>收入和支出都需要指定货币类型</p>
                    <p>4. 粘贴到下方文本框并导入</p>
                    <p>5. 支持增量更新，新数据会覆盖同月份的旧数据</p>
                </div>
                
                <div class="import-example">
                    <h4>📝 JSON格式示例（多货币支持）</h4>
                    <pre id="bills-json-example">{
  "2024-01": {
    "income": 15000,
    "incomeCurrency": "CNY",
    "expenses": [
      {"name": "房租", "amount": 3000, "currency": "CNY", "category": "住房"},
      {"name": "生活费", "amount": 2000, "currency": "CNY", "category": "生活"},
      {"name": "澳洲账单", "amount": 500, "currency": "AUD", "category": "账单"}
    ]
  },
  "2024-02": {
    "income": 3200,
    "incomeCurrency": "AUD",
    "expenses": [
      {"name": "房租", "amount": 3000, "currency": "CNY", "category": "住房"},
      {"name": "澳洲生活费", "amount": 600, "currency": "AUD", "category": "生活"}
    ]
  }
}</pre>
                </div>
                
                <div class="import-input">
                    <h4>📥 导入数据</h4>
                    <textarea id="bills-import-data" placeholder="粘贴JSON数据..." rows="8" style="width: 100%; font-family: monospace;"></textarea>
                </div>
                
                <div id="bills-import-preview" style="display: none;">
                    <h4>📊 数据预览</h4>
                    <div id="bills-preview-content"></div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('bills-import-modal')">取消</button>
                <button type="button" class="btn btn-primary" onclick="window.previewBillsData()">预览数据</button>
                <button type="button" class="btn btn-success" onclick="window.confirmBillsImport()" id="confirm-bills-import" style="display: none;">确认导入</button>
            </div>
        </div>
    </div>

    <!-- 月度对比模态框 -->
    <div id="monthly-comparison-modal" class="modal modal-large">
        <div class="modal-content">
            <h3 class="modal-title">月度对比分析</h3>
            <div class="modal-body">
                <!-- 年份选择器 - 居中对齐 -->
                <div class="comparison-year-selector">
                    <button onclick="window.changeComparisonYear(-1)">◀ 上一年</button>
                    <span class="year-display" id="comparison-year">2024</span>
                    <button onclick="window.changeComparisonYear(1)">下一年 ▶</button>
                </div>
                <div id="monthly-comparison-content"></div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('monthly-comparison-modal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 账户管理模态框 -->
    <div id="account-management-modal" class="modal modal-large">
        <div class="modal-content">
            <h3 class="modal-title">财务账户管理</h3>
            <div class="modal-body">
                <div id="account-management-content"></div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.closeModal('account-management-modal')">关闭</button>
            </div>
        </div>
    </div>

</body>
</html>